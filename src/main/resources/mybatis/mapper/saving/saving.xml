<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.swyp.doubleSeven.domain.saving.dao.SavingDAO">
    <!-- resultMap -->
    <resultMap id="SavingResultResMap" type="com.swyp.doubleSeven.domain.saving.dto.response.SavingResponse">
        <id property="savingId" column="SAVING_ID"/>
        <result property="savingYmd" column="SAVING_YMD"/>
        <result property="categoryName" column="SUB_CATEGORY_NAME"/>
        <result property="amount" column="AMOUNT"/>
    </resultMap>

    <!-- 가상 소비 등록 -->
    <insert id="insertSaving">
        INSERT INTO SAVING (
            MEMBER_ID,
            SAVING_YMD,
            AMOUNT,
            MAIN_CATEGORY_ID,
            SUB_CATEGORY_ID,
            RGST_ID,
            RGST_DT,
            UPDT_ID,
            UPDT_DT
        )
        SELECT
            1, <!-- 임시 MEMBER_ID -->
            #{savingRequest.savingYmd},
            #{savingRequest.amount},
            mc.MAIN_CATEGORY_ID,
            sc.SUB_CATEGORY_ID,
            1, <!-- 임시 RGST_ID -->
            CURRENT_TIMESTAMP,
            1, <!-- 임시 UPDT_ID -->
            CURRENT_TIMESTAMP
        FROM SUB_CATEGORY sc
        JOIN MAIN_CATEGORY mc ON sc.MAIN_CATEGORY_ID = mc.MAIN_CATEGORY_ID
        WHERE sc.SUB_CATEGORY_NAME = #{savingRequest.categoryName}
    </insert>

    <resultMap id="monthlySavingMap" type="com.swyp.doubleSeven.domain.saving.dto.response.SavingCalendarDayInfoResponse">
        <id property="day" column="day"/>
        <collection property="categorySummaries" ofType="com.swyp.doubleSeven.domain.saving.dto.response.CategorySummary">
            <result property="categoryName" column="SUB_CATEGORY_NAME"/>
            <result property="categoryTotalAmount" column="CATEGORY_TOTAL_AMOUNT"/>
        </collection>
        <collection property="items" ofType="com.swyp.doubleSeven.domain.saving.dto.response.SavingResponse">
            <id property="savingId" column="SAVING_ID"/>
            <result property="savingYmd" column="SAVING_YMD"/>
            <result property="categoryName" column="SUB_CATEGORY_NAME"/>
            <result property="amount" column="AMOUNT"/>
        </collection>
    </resultMap>

    <select id="selectSavingMonthly" resultMap="monthlySavingMap">
        SELECT
            DAY(s.SAVING_YMD) as day,
            s.SAVING_ID,
            DATE_FORMAT(s.SAVING_YMD, '%Y-%m-%d %H:%i:%s') as SAVING_YMD,
            sub.SUB_CATEGORY_NAME,
            s.AMOUNT,
        (SELECT SUM(amount)
        FROM SAVING s3
        JOIN SUB_CATEGORY sub3 ON s3.SUB_CATEGORY_ID = sub3.SUB_CATEGORY_ID
        WHERE DAY(s3.SAVING_YMD) = DAY(s.SAVING_YMD)
            AND sub3.SUB_CATEGORY_NAME = sub.SUB_CATEGORY_NAME
            AND YEAR(s3.SAVING_YMD) = #{year}
            AND MONTH(s3.SAVING_YMD) = #{month}
            AND s3.MEMBER_ID = 1) as category_total_amount
        FROM SAVING s
            LEFT JOIN SUB_CATEGORY sub ON s.SUB_CATEGORY_ID = sub.SUB_CATEGORY_ID
        WHERE s.MEMBER_ID = 1
            AND YEAR(s.SAVING_YMD) = #{year}
            AND MONTH(s.SAVING_YMD) = #{month}
        <if test="categoryName != null and categoryName != ''">
            AND sub.SUB_CATEGORY_NAME = #{categoryName}
        </if>
        GROUP BY
            DAY(s.SAVING_YMD),
            s.SAVING_ID,
            sub.SUB_CATEGORY_NAME,
            s.AMOUNT
        ORDER BY
            day ASC,
            s.SAVING_YMD ASC
    </select>

    <!--  맵: 가상 소비 조회 (리스트) -->
    <resultMap id="SavingListResMap" type="com.swyp.doubleSeven.domain.saving.dto.response.SavingListResponse">
        <result property="totalAmount" column="total_amount"/>
        <collection property="items" ofType="com.swyp.doubleSeven.domain.saving.dto.response.SavingResponse">
            <id property="savingId" column="SAVING_ID"/>
            <result property="savingYmd" column="SAVING_YMD"/>
            <result property="amount" column="AMOUNT"/>
            <result property="categoryName" column="SUB_CATEGORY_NAME"/>
        </collection>
    </resultMap>

    <!-- 가상 소비 조회 (리스트) -->
    <select id="selectSavingList" resultMap="SavingListResMap">
        SELECT
            s.SAVING_ID,
            s.SAVING_YMD,
            s.AMOUNT,
            s.MEMO,
            m.MAIN_CATEGORY_ID,
            m.MAIN_CATEGORY_NAME,
            sub.SUB_CATEGORY_ID,
            sub.SUB_CATEGORY_NAME,
        (SELECT
             SUM(amount)
        FROM SAVING
        WHERE MEMBER_ID = 1
            AND YEAR(SAVING_YMD) = #{year}
            AND MONTH(SAVING_YMD) = #{month}
        ) as total_amount
        FROM SAVING s
            LEFT JOIN MAIN_CATEGORY m ON s.MAIN_CATEGORY_ID = m.MAIN_CATEGORY_ID
            LEFT JOIN SUB_CATEGORY sub ON s.SUB_CATEGORY_ID = sub.SUB_CATEGORY_ID
        WHERE s.MEMBER_ID = 1                                                           <!-- 임시 RGST_ID -->
            AND YEAR(s.SAVING_YMD) = #{year}
            AND MONTH(s.SAVING_YMD) = #{month}
        ORDER BY ${sortType.sqlOrderBy}
    </select>

    <!-- 가상 소비 단건 조회 -->
    <select id="selectSaving" parameterType="Integer" resultMap="SavingResultResMap">
        SELECT
            s.SAVING_ID,
            s.SAVING_YMD,
            s.AMOUNT,
            s.MEMO,
            s.MAIN_CATEGORY_ID,
            mc.MAIN_CATEGORY_NAME,
            s.SUB_CATEGORY_ID,
            sc.SUB_CATEGORY_NAME
        FROM
            SAVING s
                JOIN MAIN_CATEGORY mc ON s.MAIN_CATEGORY_ID = mc.MAIN_CATEGORY_ID
                JOIN SUB_CATEGORY sc ON s.SUB_CATEGORY_ID = sc.SUB_CATEGORY_ID
        WHERE
            s.SAVING_ID = #{savingId}
    </select>


    <!-- 가상 소비 수정 -->
    <update id="updateSaving">
        UPDATE SAVING s
        SET
            s.SAVING_YMD = #{savingRequest.savingYmd},
            s.AMOUNT = #{savingRequest.amount},
            s.MAIN_CATEGORY_ID = (
        SELECT sc.MAIN_CATEGORY_ID
        FROM SUB_CATEGORY sc
        WHERE sc.SUB_CATEGORY_NAME = #{savingRequest.categoryName}
        ),
        s.SUB_CATEGORY_ID = (
        SELECT sc.SUB_CATEGORY_ID
        FROM SUB_CATEGORY sc
        WHERE sc.SUB_CATEGORY_NAME = #{savingRequest.categoryName}
        ),
        s.UPDT_ID = 1, <!-- 임시 UPDT_ID -->
        s.UPDT_DT = CURRENT_TIMESTAMP
        WHERE s.SAVING_ID = #{savingId}
    </update>

    <!-- 가상 소비 삭제 -->
    <delete id="deleteSaving">
        DELETE
        FROM
            SAVING
        WHERE SAVING_ID = #{savingId}
    </delete>
</mapper>